openapi: "3.0.3"
info:
  title: "Ghana Police Ticketing - Offline Sync API"
  description: |
    Handles batch synchronization of tickets and photos created offline on handheld devices.
    Supports conflict resolution (server-wins strategy) and bidirectional sync.

    Key behaviours:
    - Server-wins conflict resolution: when a ticket has been modified on both the server
      and the device since the last sync, the server version takes precedence. Conflicts
      are reported back so the device can update its local copy.
    - Idempotency via clientCreatedId: duplicate submissions with the same clientCreatedId
      are safely ignored and return the existing server record.
    - Maximum batch size of 50 items per sync request.
    - Photos are limited to 5 MB each (base64-encoded).
  version: "1.0.0"

servers:
  - url: "http://localhost:8000/api"
    description: "Development"

security:
  - bearerAuth: []

paths:
  /sync:
    post:
      tags:
        - Sync
      summary: Batch sync from device
      description: |
        Accepts a batch of offline-created or offline-updated tickets and photos
        from a handheld device and returns the results of each item along with any
        server-side updates that occurred since the device's last sync.

        Business rules:
        - Maximum 50 items total (tickets + photos combined) per request.
        - Each photo must not exceed 5 MB (base64-encoded).
        - Idempotent via clientCreatedId on tickets: re-submitting the same
          clientCreatedId returns the existing server record without creating a duplicate.
        - Server-wins conflict resolution: timestamps are compared and the server
          version is authoritative when both sides have changes.
      operationId: batchSync
      parameters:
        - name: X-Device-ID
          in: header
          description: Unique identifier of the syncing device
          schema:
            type: string
          example: "device-abc-123"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SyncRequest"
            example:
              lastSyncTimestamp: "2026-01-15T08:30:00Z"
              tickets:
                - id: "local-ticket-001"
                  action: "create"
                  data:
                    clientCreatedId: "client-uuid-001"
                    vehicleRegistration: "GR-1234-20"
                    offenceIds:
                      - "off-uuid-001"
                    totalFine: 200.00
                    location: "Accra Ring Road"
                  timestamp: "2026-01-15T10:05:00Z"
              photos:
                - ticketId: "local-ticket-001"
                  photoId: "local-photo-001"
                  data: "/9j/4AAQSkZJRg..."
                  type: "vehicle"
      responses:
        "200":
          description: Sync completed successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SyncResponse"
              example:
                syncTimestamp: "2026-01-15T10:10:00Z"
                results:
                  tickets:
                    - localId: "local-ticket-001"
                      serverId: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
                      status: "success"
                  photos:
                    - localId: "local-photo-001"
                      serverId: "p1q2r3s4-t5u6-7890-abcd-ef1234567890"
                      status: "success"
                      url: "https://storage.example.com/photos/p1q2r3s4.jpg"
                serverUpdates:
                  tickets:
                    - id: "b2c3d4e5-f6a7-8901-bcde-f12345678901"
                      action: "update"
                      data:
                        status: "paid"
                        paidAt: "2026-01-15T09:00:00Z"
        "400":
          description: Validation error (e.g., batch too large, invalid data)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error:
                  code: "BATCH_SIZE_EXCEEDED"
                  message: "Maximum batch size of 50 items exceeded"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "413":
          description: Photo payload too large (exceeds 5 MB)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error:
                  code: "PHOTO_TOO_LARGE"
                  message: "Photo exceeds the maximum allowed size of 5 MB"

  /sync/status:
    get:
      tags:
        - Sync
      summary: Get sync status for current device
      description: |
        Returns the sync status for the authenticated user's device, including
        the timestamp of the last successful sync and the number of pending
        server-side updates since that sync.
      operationId: getSyncStatus
      parameters:
        - name: deviceId
          in: query
          description: >
            Device identifier. If omitted, defaults to the value of the
            X-Device-ID header.
          schema:
            type: string
          example: "device-abc-123"
        - name: X-Device-ID
          in: header
          description: Unique identifier of the device (used as fallback when deviceId query param is omitted)
          schema:
            type: string
          example: "device-abc-123"
      responses:
        "200":
          description: Sync status retrieved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SyncStatus"
              example:
                lastSyncTimestamp: "2026-01-15T08:30:00Z"
                pendingServerUpdates: 3
                deviceId: "device-abc-123"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT access token obtained from the login endpoint

  schemas:
    SyncRequest:
      type: object
      description: Batch sync payload from the device
      required:
        - lastSyncTimestamp
      properties:
        lastSyncTimestamp:
          type: string
          format: date-time
          description: Timestamp of the device's last successful sync
          example: "2026-01-15T08:30:00Z"
        tickets:
          type: array
          description: Tickets created or updated offline
          items:
            $ref: "#/components/schemas/SyncTicketItem"
        photos:
          type: array
          description: Photos captured offline
          items:
            $ref: "#/components/schemas/SyncPhotoItem"

    SyncTicketItem:
      type: object
      description: A single ticket to sync from the device
      required:
        - id
        - action
        - data
        - timestamp
      properties:
        id:
          type: string
          description: Local identifier of the ticket on the device
          example: "local-ticket-001"
        action:
          type: string
          description: Whether this ticket is being created or updated
          enum:
            - create
            - update
          example: "create"
        data:
          type: object
          description: >
            The ticket data payload. For creates, this should contain all required
            ticket fields including clientCreatedId. For updates, this should contain
            only the changed fields plus the server-assigned ticket id.
          additionalProperties: true
        timestamp:
          type: string
          format: date-time
          description: When this change was made on the device
          example: "2026-01-15T10:05:00Z"

    SyncPhotoItem:
      type: object
      description: A single photo to sync from the device
      required:
        - ticketId
        - photoId
        - data
        - type
      properties:
        ticketId:
          type: string
          description: Local or server ID of the ticket this photo belongs to
          example: "local-ticket-001"
        photoId:
          type: string
          description: Local identifier of the photo on the device
          example: "local-photo-001"
        data:
          type: string
          description: Base64-encoded photo data (maximum 5 MB)
          example: "/9j/4AAQSkZJRg..."
        type:
          type: string
          description: Category of the photo
          enum:
            - vehicle
            - plate
            - evidence
            - other
          example: "vehicle"

    SyncResponse:
      type: object
      description: Response from a batch sync operation
      required:
        - syncTimestamp
        - results
        - serverUpdates
      properties:
        syncTimestamp:
          type: string
          format: date-time
          description: The server timestamp of this sync (use as lastSyncTimestamp in next sync)
          example: "2026-01-15T10:10:00Z"
        results:
          type: object
          description: Results for each item submitted by the device
          required:
            - tickets
            - photos
          properties:
            tickets:
              type: array
              description: Result for each submitted ticket
              items:
                $ref: "#/components/schemas/SyncTicketResult"
            photos:
              type: array
              description: Result for each submitted photo
              items:
                $ref: "#/components/schemas/SyncPhotoResult"
        serverUpdates:
          type: object
          description: Changes on the server since the device's last sync
          required:
            - tickets
          properties:
            tickets:
              type: array
              description: Tickets that were updated or deleted on the server
              items:
                $ref: "#/components/schemas/ServerUpdate"

    SyncTicketResult:
      type: object
      description: Outcome of syncing a single ticket
      required:
        - localId
        - serverId
        - status
      properties:
        localId:
          type: string
          description: The local ID submitted by the device
          example: "local-ticket-001"
        serverId:
          type: string
          description: The server-assigned UUID for this ticket
          example: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
        status:
          type: string
          description: Outcome of the sync for this ticket
          enum:
            - success
            - conflict
            - error
          example: "success"
        error:
          type: string
          description: Error message if status is conflict or error
          example: null

    SyncPhotoResult:
      type: object
      description: Outcome of syncing a single photo
      required:
        - localId
        - serverId
        - status
      properties:
        localId:
          type: string
          description: The local photo ID submitted by the device
          example: "local-photo-001"
        serverId:
          type: string
          description: The server-assigned UUID for this photo
          example: "p1q2r3s4-t5u6-7890-abcd-ef1234567890"
        status:
          type: string
          description: Outcome of the sync for this photo
          enum:
            - success
            - error
          example: "success"
        url:
          type: string
          format: uri
          description: Public URL of the uploaded photo (present on success)
          example: "https://storage.example.com/photos/p1q2r3s4.jpg"

    ServerUpdate:
      type: object
      description: A server-side change to push to the device
      required:
        - id
        - action
      properties:
        id:
          type: string
          format: uuid
          description: Server ID of the ticket that changed
          example: "b2c3d4e5-f6a7-8901-bcde-f12345678901"
        action:
          type: string
          description: Type of change that occurred on the server
          enum:
            - update
            - delete
          example: "update"
        data:
          type: object
          description: Updated ticket data (present for update actions, omitted for deletes)
          additionalProperties: true

    SyncStatus:
      type: object
      description: Current sync status for a device
      required:
        - lastSyncTimestamp
        - pendingServerUpdates
        - deviceId
      properties:
        lastSyncTimestamp:
          type: string
          format: date-time
          description: Timestamp of the last successful sync for this device
          example: "2026-01-15T08:30:00Z"
        pendingServerUpdates:
          type: integer
          description: Number of server-side changes since the last sync
          example: 3
        deviceId:
          type: string
          description: The device identifier
          example: "device-abc-123"

    ErrorResponse:
      type: object
      description: Standard error response
      properties:
        error:
          type: object
          properties:
            code:
              type: string
              description: Machine-readable error code
              example: "VALIDATION_ERROR"
            message:
              type: string
              description: Human-readable error message
              example: "Validation failed for the request"
            details:
              type: array
              description: Detailed error information
              items:
                type: object
                properties:
                  field:
                    type: string
                    example: "tickets[0].data"
                  message:
                    type: string
                    example: "Missing required field: clientCreatedId"
          required:
            - code
            - message
      required:
        - error
